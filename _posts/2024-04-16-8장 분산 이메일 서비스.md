---
layout: post
title:  "8장. 분산 이메일 서비스"
date:   2024-04-16 00:00:00 +0900
categories: study books system-design-interview-vol2
---
발표일: 2024년 4월 16일
발표자: 홍성민

## 기능 요구사항

- 이메일 발송/수신
- 모든 이메일 가져오기
- 읽은 여부에 따른 이메일 필터링
- 제목, 발신인, 메일 내용에 따른 검색 기능
- 스팸 및 바이러스 방지 기능

## 비기능 요구사항

- 안전성
    - 데이터  소실을 막아야한다
- 가용성
    - 여러 노드에 복제해 가용성을 보장하고 부분적으로 장애가 발생해도 시스템은 계속 동작해야 한다.
- 확장성
    - 사용자 수가 늘어도 감당할 수 있어야 한다.
- 유연성과 확장성
    - 새 컴포넌트를 더하여 쉽게 기능을 추가하고 성능을 개선할 수 있는 시스템이어야 한다;.

## 개략적인 규모 추정

- 10억명의 사용자
- 한 사람이 하루에 보내는 평균 이메일 수 10건
- 한 사람이 하루에 수신하는 이메일 수는 40건

# 개략적 설계안

## 이메일 프로토콜

- SMTP
    - 이메일을 한 서버에서 다른 서버로 보내는 표준 프로토콜
- POP
    - 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드하기 위해 사용하는 표준 프로토콜
    - 단말로 다운로드된 이메일은 서버에서 삭제된다. 결과적으로 한 대 단말에서만 이메일을 읽을 수 있다.
- IMAP
    - 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하는데 사용하는 프로토콜(개인 이메일 계정에서 가장 널리 사용)
    - 단말로 다운로드된 이메일은 서버에서 삭제되지 않는다. 결과적으로 여러 단말에서 이메일을 읽을 수 있다.
- HTTPS
    - 웹 기반 이메일 시스템의 메일함 접속에 이용할 수 있다. 마이크로소프트 아웃룩은 액티브싱크라는 HTTPS 기반 자체 프로토콜을 통해 모바일 단말과의 통신을 처리한다.

## 이메일 전송 절차

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled.png)

1. 사용자가 웹메일 환경에서 메일을 작선한 다음 전송 버튼을 누른다. 요청은 로드밸런서로 전송된다.
2. 로드밸런스는 처리율 제한(rate limit) 한도 를 넘지 않는 선에서 요청을 웹서버로 전달한다.
3. 웹 서버는 다음 역할을 담당한다.
    - 기본적인 이메일 검증: 이메일 크기 한도처럼 사전에 미리 정의된 규칙을 사용하여 수신된 이메일을 검사한다.
        - 수신자 이메일 주소 도메인이 송신자 이메일 주소 도메인과 같은지 검사: 같다면 웹 서버는 이메일 내용의 스팸 여부와 바이러스 감염 여부를 검사한다. 검사를 문제없이 통과한 이메일은 송신인의 ‘보낸 편지함' 수신인의 ‘받은 편지함‘에 저장된다. 수신인 측 클라이언트는 RESTful API를 사용하여 이메일을 바로 가져올 수 있으며, 4단계 이후는 수행할 필요가 없다.
4. 메시지 큐
    1. 기본적인 검증에 실패한 이메일을 에러큐에 보관한다.
    2. 기본적인 검증을 통과한 이메일은 외부 전송 큐로 전달된다. 큐에 넣기에 첨부 파일의 크기가 너무 큰 이메일의 경우에는 첨부 파일은 객체 저장소에 따로 저장하고 큐에 전달하는 이메일 안에는 해당 저장 위치에 대한 참조 정보만 보관한다.
5. 외부 전송 담당 SMTP 작업 프로세스는 외부 전송 큐에서 메시지를 꺼내어 이메일의 스팸 및 바이러스 감염 여부를 확인한다.
6. 검증 절차를 통과한 이메일은 저장소 계층 내의 ‘보낸 편지함’에 저장된다.
7. 외부 전송 담당 SMTP 작업 프로세스가 수신자의 메일 서버로 메일을 전송한다.

## 이메일 수신 절차

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled%201.png)

1. 이메일이 SMTP 로드밸런서에 도착한다.
2. 로드밸런서는 트래픽을 여러 SMTP 서버로 분산한다. SMTP 연결에는 이메일 수락 정책을 구성하여 적용할 수 있다. 예를 들어 유효하지 않은 이메일은 반송하도록 하면 불필요한 이메일 처리를 피할 수 있다.
3. 이메일의 첨부 파일이 큐에 들어가기 너무 큰 경우에는 첨부 파일 저장소에 보관한다.
4. 이메일을 수신 이메일 큐에 넣는다. 이 큐는 메일 처리 작업 프로세스와 SMTP 서버 간의 결합도를 낮추어 각자 독립적으로 규모 확장이 가능하도록 한다. 갑자기 수신되는 이메일의 양이 폭증하는 경우 버퍼 역할도 한다.
5. 메일 처리 작업 프로세스(worker)는 스팸 메일을 걸러내고 바이러스를 차단하는 등의 다양한 역할을 한다. 아래의 절차들은 검증 작업이 끝난 이메일을 대상으로 한다.
6. 이메일을 메일 저장소, 캐시, 객체 저장소 등에 보관한다.
7. 수신자가 온라인 상태인 경우 이메일을 실시간 서버로 전달한다.
8. 실시간 서버는 수신자 클라이언트가 새 이메일을 실시간으로 받을 수 있도록 하는 웹소컷 서버다.
9. 오프라인 상태 사용자의 이메일은 저장소 계층에 보관한다. 해당 사용자가 온라인 상태가 되면 웹메일 클라이언트는 웹 서버에 RESTful API를 통해 연결한다.
10. 웹 서버는 새로운 이메일을 저장소 계층에서 가져와 클라이언트에 반환한다.

# 상세 설계

## 메타데이터 데이터베이스

### 이메일 메타데이터 특성

- 이메일의 헤더는 일반적으로 작은편
- 본문 크기는 작은 것 부터 큰 것까지 다양하지만 사용 빈도는 낮음(보통 이메일을 한 번만 읽음)
- 이메일 가져오기, 읽은 메일로 표시, 검색 등의 이메일 관련 작업은 사용자별로 격리 수행되어야 한다.
- 사용자는 보통 최근 메일만 읽는다. 만들어진 지 16일 이하 데이터에 발생하는 읽기 질의 비율은 전체 질의의 82%에 달한다.
- 데이터 안정성이 보장되어야한다. 데이터 손실은 용납 안함

### 적합한 데이터베이스 선정

- 관계형 데이터베이스
    - RDB는 이메일을 효율적으로 검색할 수 있기 때문이다. 이메일 헤더와 본문에 대한 인덱스를 만들어 두면 간단한 검색 질의는 빠르게 처리할 수 있다.
    - RDB는 데이터 크기가 작을 때 적합하다. 비정형 BLOB 자료형이 있지만 해당 자료형은 검색 질의 성능이 좋지 않다. BLOB 자료형이 고정된 크기 페이지를 연결하여 큰 데이터를 저장하도록 하고 있어 해당 컬럼의 데이터를 접근할 때마다 많은 디스크 I/O가 발생하기 때문이다.
    - 결국 MySQL이나 PostgreSQL 같은 관계형 데이터베이스는 바람직하지 않다.
- 분산 객체 저장소
    - 이메일의 원시데이터를 그대로 아마존 S3같은 객체 저장소에 보관하는 것이다.
    - 백업 데이터를 보관하기에는 좋지만 이메일의 읽음 표시, 키워드 검색, 이메일 threads 등의 기능을 구현하기에 좋지 못하다
- NOSQL DB
    - 지메일은 구글 빅테이블을 저장소로 사용한다. 하지만 빅테이블은 오픈소스로 공개되어 있지 않아 사용할 수 없다.
    - 카산드라가 대안이 될 수 있지만 대형 이메일 서비스 제공 업체 가운데 현재 카산드라를 사용한 곳은 확인된 바가 없다.

결국 분석 결과에 따르면 본 설계안이 필요로 하는 기능을 완벽히 지원하는 데이터베이스는 없다. 대형 이메일 서비스 업체는 대체로 독자적인 데이터베이스 시스템을 만들어 사용한다.

다만 필요한 데이터베이스가 다음 조건을 충족해야 한다는 것만 정리하고 간다.

- 어떤 단일 칼럼의 크기는 한 자릿수 MB 정도일 수 있다.
- 강력한 데이터 일관성이 보장되어야 한다.
- 디스크 I/O가 최소화되도록 설계되어야 한다.
- 가용성이 아주 높아야 하고 일부 장애를 감내할 수 있어야 한다.
- 증분 백업(incremental backup)이 쉬워야 한다.
    - 증분 백업의미: 마지막 백업 이후 변경되거나 새로 생성된 데이터만을 저장하는 방식
    - 전체 데이터를 매번 백업하지 않고 최근 변경 사항만을 추가로 백업
    - 백업에 필요한 시간과 저장 공간을 줄일 수 있어 효율적
    - 데이터를 복구할 때는 과정이 조금 복잡한 편

## 검색

기본적인 이메일 검색은 보통 이메일 제목이나 본문에 특정 키워드가 포함되었는지 찾는 것을 뜻한다. 고급 기능에는 ‘발신인(From)’, ‘제목(Subject)’, ‘읽지 않은’ 같이 메일 속성에 따른 필터링 기능이 포함된다. 검색 기능을 제공하려면 이메일이 전송, 수신, 삭제될 때마다 색인 작업을 수행해야 한다. 그에 반해 검색은 사용자가 ‘검색’ 버튼을 누를 때만 실행된다. 따라서 이메일 시스템의 검색 기능에는 쓰기 연산이 읽기 연산보다 훨씬 많이 발생한다.

### 방안1: 일랙스틱서치

user_id를 파티션 키로 사용해 같은 사용자의 이메일은 같은 노드에 묶는다.

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled%202.png)

검색 요청은 동기 방식으로 처리한다. 이메일 전송, 수신, 삭제 같은 이벤트는 처리 결과를 클라이언트로 전달할 필요는 없다. 필요한 건 색인 작업이고 이 프로세스는 백그라운드 작업 형태로 처리될 수 있다. 카프카를 활용해 색인 작업을 시작하는 서비스와 실제로 색인을 수행할 서비스 사이의 결합도를 낮추는 방안을 채택했다. 까다로운 문제는 주 이메일 저장소(DB)와 동기화를 맞추는 부분이다.

### 방안2: 맞춤형 검색 솔루션

대규모 이메일 서비스 사업자는 보통 검색 엔진을 자체적으로 개발해 사용한다. 여기서는 주요 과제인 디스크 I/O 병목 문제만 간단하게 다루도록 한다.

색인을 구축하는 프로세스는 다량의 쓰기 연산을 발생시킬 수밖에 없으므로 LSM(Long-Structured Merge) 트리를 사용하여 디스크에 저장되는 색인을 구조화하는 것이 바람직한 전략일 것이다. 

- . LSM 트리
    - 원리는 모든 쓰기(삽입, 수정, 삭제) 연산을 먼저 메모리에 있는 로그와 같은 구조에 저장하고, 이후에 배치(batch) 형태로 디스크에 비동기적으로 저장하는 방식임
    

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled%203.png)

쓰기 경로는 순차적 쓰기 연산만 수행하도록 최적화되어 있다. LSM 트리는 빅테이블이나 카산드라 RocksDB같은 데이터베이스의 핵심 자료 구조다. 

새로운 이메일이 도착하면 우선 메모리 캐시로 구현되는 0번 계층에 추가된다. 메모리에 보관된 데이터의 양이 사전에 정의된 임계치를 넘으면 데이터는 다음 계층에 병합된다.

두 가지 방안의 장단점을 비교해 보면 다음과 같다.

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled%204.png)

소규모의 이메일 시스템을 구축하는 경우 일래스틱서치가 좋은 선택지다. 통합하기 쉽고 엔지니어링에 많은 노력이 필요치 않다. 

네이버메일에서는 Noir 솔루션을 개발해서 검색 시스템을 구현했다고 함.

[NAVER D2](https://tv.naver.com/v/33919079)

일래스틱서치 같은 역색인 방식에서 부분 압축 + 풀스캔 방식인 Noir를 사용하고 장비를 85% 줄일 수 있었다고 함.

read와 관련있는 IO time은 압축으로 단축시키고 검색과 관련있는 CPU time은 병렬실행(부분 압축을 해야만 가능)으로 줄여서 풀스캔임에도 전체 검색시간을 짧게 함

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled%205.png)

![Untitled](/208/assets/img/study/books/system-design-interview-vol2/chapter08/Untitled%206.png)

데뷰 발표 자료

[https://deview.kr/data/deview/session/attach/[223]Noir-+메일검색+서버를+반의+반으로+줄여준+신규+검색엔진+제작기.pdf](https://deview.kr/data/deview/session/attach/[223]Noir-+메일검색+서버를+반의+반으로+줄여준+신규+검색엔진+제작기.pdf)

커스텀한 DB를 만들지 않으면 분산 이메일 서비스를 구현할 수 없다는 한계가 있어서 좀 아쉬웠던 장이다. 끗