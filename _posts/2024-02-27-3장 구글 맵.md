---
layout: post
title:  "3장. 구글 맵"
date:   2024-02-27 00:00:00 +0900
categories: study books system-design-interview-vol2
announced_on: 2024년 2월 27일
author: 윤현준
---
구글맵은 DAU 10억 명, 전 세계 99% 지역의 지도를 제공하고, 정확한 실시간 위치 정보를 제공하기 위해 매일 2500 만 건의 업데이트를 반영한다.

## 1단계: 문제 이해 및 설계 범위 확정

**문제 이해를 위한 질문**

- 일간 능동 사용자 수는 어느 정도로 생각하나요? 10억 DAU 로 가정합니다.
- 어떤 기능에 초점을 맞추어야 하나요? 위치 갱신, 경로 안내, ETA, 지도 표시가 중요합니다.
- 도로데이터는 어느 정도 규모인가요? 확보했다고 가정하나요? 다양한 경로로 확보했고, 수 TB 정도의 가공되지 않은 데이터 입니다.
- 운전, 도보, 대중교통과 같은 이동 방법을 고려해야 할까요? 다양한 이동 방법을 지원해야 합니다.
- 경유지를 설정해야 할까요? 좋기는 하지만, 신경쓰지 않기로 합니다.
- 사업장 위치나 사진도 표시하나요? 그래야 한다면 몇 장 정도 일까요? 이번에 고려하지 않습니다.

ETA(예상도착시간): Estimated Time of Arrival

### 질문을 통한 기능 요구사항 정리

주 단말을 스마트 폰으로 가정

- 경로 안내 서비스(ETA 서비스 포함)
- 사용자 위치 갱신
- 지도 표시

## 문제 해결을 위한 기본 개념 및 용어

### 지도 101

**측위 시스템**

구 표면 상의 위치를 표현하는 체계로 위경도 기반 측위 시스템의 경우 위도와 경도를 통해 주어진 위치를 나타낸다.

![스크린샷 2024-02-27 오전 3.08.31.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.08.31.png" | relative_url }})

**3차원 위치의 2차원 변환(**[https://medium.com/google-design/google-maps-cb0326d165f5](https://medium.com/google-design/google-maps-cb0326d165f5))

지도 투영법 혹은 도법이라 부르며, 다양한 도법이 있고 그 중 구글 맵은 메르카토르 도법을 택한다.

> There are a few reasons for picking Mercator, but the best reason is that north and south are straight up and down, and east and west are straight left and right — on some of the other projections these lines would curve or deviate as you move across the map
> 

![스크린샷 2024-02-27 오전 3.09.03.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.09.03.png" | relative_url }})

**지오코딩**

주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스, 결과를 반대로 주소로 변환하는 프로세스는 역 지오코딩이라고 한다.

ex) 서울 마포구 > 37.57636667 126.9388972

**지오해싱(**[https://guzene.tistory.com/337](https://guzene.tistory.com/337))

지도 위 특정 영역을 영문자와 숫자로 구성된 짦은 문자열에 대응시키는 인코딩 체계

GPS 좌표를 지도를 축소하며 이진수로 변경하고 이를 32진수로 변경한다. 

![스크린샷 2024-02-27 오전 3.11.41.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.11.41.png" | relative_url }})

**지도 표시**

지도를 화면에 표시하는데 가장 기본이 되는 개념은 타일(tile)이다. 지도의 확대/축소를 지원하려면 확대 수준에 따라 다른 종류의 타일을 준비해야 하고 확대 수준에 근거해 필요한 타일만 다운받아 사용한다.

**경로 안내 알고리즘을 위한 도로 데이터 처리**

여러 경로 탐색 알고리즘 중 하나를 선정하는 것은 깊이 다루지 않는다. 모든 경로 탐색 알고리즘은 교차로를 노드로, 도로는 노드를 잇는 선으로 표현하는 그래프 자료구조를 가정한다. 전 세계 도로망을 하나의 그래프로 표현하려면 메모리의 한계가 있으므로 세계를 격자로 나누어 경로 안내 타일로 관리한다. 이 때 각 타일은 다른 타일에 대한 참조를 유지한다.

![스크린샷 2024-02-27 오전 3.17.32.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.17.32.png" | relative_url }})

![스크린샷 2024-02-27 오전 3.18.34.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.18.34.png" | relative_url }})

![스크린샷 2024-02-27 오전 3.20.15.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.20.15.png" | relative_url }})

![스크린샷 2024-02-27 오전 3.25.26.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-27_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_3.25.26.png" | relative_url }})

**계층적 경로 안내 타일**

정밀도가 높은 타일만으로 알고리즘을 돌리면 결과를 얻는 데 많은 시간이 걸린다. + 많은 메모리가 필요하다. 보통 구체성 정도를 상(지방도로), 중(간선도로), 하(고속도로)로 구분하여 세 가지 종류의 경로 안내 타일을 준비한다. 

### 개략적 규모 추정

**저장소 사용량**

- 세계지도: 확대 수준 별로 지도 타일을 한벌 씩 두어야 한다. 세계 지도를 21번 확대하여 볼 수 있으려면 약 4.4조 개의 타일이 필요하다. 한 장의 타일이 256x256 픽셀 압축 PNG 파일이라면 장당 100KB 저장 공간이 필요하여 최대 확 대 시 4.4조 X 100KB = 440PB 저장 공간이 필요하다. 하지만 인간이 살지 않는 곳은 압축이 가능하여 보수적으로 80~90% 절약이 가능하다. 각 수준 별로 필요한 저장공간을 합하면 약 100 PB 가 필요하다.
- 메타데이터: 각 지도 타일의 메타데이터는 크기가 작아 무시가 가능하므로 추정에서 제외한다.
- 도로 정보: 앞 서 논의했던 가공 전 수 TB 데이터와 비슷한 규모일 것이다.

**서버 대역폭**

대역폭 추정을 위해 요청 유형 정리가 필요하다.

- 경로 안내 요청: 경로 안내 세션을 시작할 때 전송하는 메시지
- 위치 갱신 요청: 변경된 사용자 위치를 전송하는 메시지

경로 안내 요청 QPS 분석

1. DAU 는 10억이며 각 사용자가 경로 안내 기능을 평균 주당 35분 사용한다고 가정한다.
2. 주당 350억분을 사용하므로 하루에 50억 분을 사용한다.
3. 매초 GPS 좌표를 전송한다면 3000억 건의 요청이 발생하고 이는 대략 300만 QPS 에 해당한다.
4. 클라이언트에서 배치 처리를 한다면 QPS 를 낮출 수 있고 15초에 한번씩 전송하면 QPS 는 20만으로 줄어든다.
5. 최대 QPS 는 평균치의 5배 가량으로 가정하고, 100만으로 볼 수 있다.

## 2단계: 개략적 설계안 제시 및 동의 구하기

개략적 설계안

1. 위치 서비스(location service)
2. 경로 안내 서비스(navigation service)
3. 지도 표시(map service)

![개략적설계안.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2580%25E1%2585%25A2%25E1%2584%2585%25E1%2585%25A3%25E1%2586%25A8%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25A8%25E1%2584%2589%25E1%2585%25A5%25E1%2586%25AF%25E1%2584%2580%25E1%2585%25A8%25E1%2584%258B%25E1%2585%25A1%25E1%2586%25AB.png" | relative_url }})

### 위치 서비스

사용자는 t초 마다 자기 위치를 전송하고 DB 에 사용자의 위치를 기록한다.

1. 새로 만들어진 도로나 폐쇄된 도로를 탐지하거나, 행동을 분석해 개인화된 경험을 제공하는데 활용 할 수 있다.
2. ETA 를 정확히 산출하고 교통 상황에 따라 다른 경로를 안내할 수도 있다. 

위치가 변경될 때 마다 즉시 서버로 전송해야 할까?

- 버퍼링을 통해 일괄처리를 하는 경우 전송 빈도를 줄일 수 있다.

많은 쓰기 요청을 처리하려면 어떤 DB 를 써야할까?

- [https://aws.amazon.com/ko/compare/the-difference-between-cassandra-and-mongodb/](https://aws.amazon.com/ko/compare/the-difference-between-cassandra-and-mongodb/)
- 규모 확장이 용이한 카산드라같은 DB 가 필요하다.

통신 프로토콜은 무엇이 좋을까?

- keep-alive 옵션과 함께 HTTP 를 사용하면 효율을 높일 수 있을 것 같다.

### 경로 안내 서비스

출발지와 목적지 인자를 받아 목적지에 도착하는 빠른 경로를 찾아주는 역할을 담당한다. 

### 지도 표시

확대 수준 별로 지도 타일을 저장하려면 수백 PB 가 필요한데, 클라이언트가 모두 가지는 것은 실용적이지 않다. 언제 클라이언트는 서버에서 타일을 가져와야 할까?

1. 클라이언트의 위치, 확대 수준에 근거하여 즉석으로 타일을 만드는 방안
    - 모든 지도 타일을 동적으로 만들므로 서버에 부하가 심하다.
    - 캐시를 활용하기 어렵다.
2. 지오해싱 같은 분할법을 사용해 미리 만들어 둔 지도 타일을 클라이언트에 전달하는 방법 
    - CDN 을 이용해 캐시한 데이터를 전달하면 규모 확장과 성능에 유리하다.
    - 지오해시를 이용하는 경우 URL 을 클라이언트와 서버 중 어디서 계산할 지 고민이 필요하다.
        - 알고리즘을 여러 클라이언트에 구현하는 경우 지원 플랫폼이 많아질 때 문제가 될 수 있다. 더불어 인코딩 교체 시 많은 노력이 들어갈 수 있다.
        - 타일 URL 의 변환을 별도 서비스로 빼는 것도 좋음 방법이다.
            
            ![지도표시흐름도.drawio.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%258C%25E1%2585%25B5%25E1%2584%2583%25E1%2585%25A9%25E1%2584%2591%25E1%2585%25AD%25E1%2584%2589%25E1%2585%25B5%25E1%2584%2592%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B3%25E1%2586%25B7%25E1%2584%2583%25E1%2585%25A9.drawio.png" | relative_url }})
            

일상적인 길을 이용하는 사용자의 경향을 반영해 클라이언트에 캐시를 두면 데이터 사용량을 더욱 줄일 수 있다.

## 3단계: 상세 설계

### 데이터 모델

**경로 안내 타일**

외부 사업자나 기관이 제공한 도로 데이터를 가공하여 경로 안내 타일로 변경하며, 해상도를 달리하여 세 벌을 만든다. 각 타일은 그래프의 노드와 선분인 교차로와 도로 정보가 있다.

그래프 데이터는 메모리에 인접 리스트 형태로 보관하는 것이 일반적이지만, 메모리에 두기에 양이 너무 많기 때문에 S3 와 같은 객체 저장소에 지오해시 기준으로 파일을 보관하고 경로 안내 서비스에서 적극적으로 캐싱하는 것을 추천한다. 

**사용자 위치 데이터**

도로 데이터나 경로 안내 타일을 갱신하는 데 이용되고 실시간 교통 상황, 교통 상황 이력 데이터 베이스를 구축하므로 많은 위치 데이터를 저장하려면 많은 양의 쓰기 연산을 처리해야 하고 수평적 규모 확장이 필요하다. 카산드라를 추천한다.

| user_id | timestamp | user_mode | driving_mode | location |
| --- | --- | --- | --- | --- |
| 101 | 165435345 | active | driving | (20.0, 30.5) |

**지오코딩 데이터베이스**

주소를 위도와 경도 쌍으로 변환하는 정보를 보관하고 쓰기 연산이 드물게 발생하므로 키-값 저장소인 레디스를 추천한다.

**미리 만들어 둔 지도 이미지**

위에 언급한 것 처럼 이미지는 만들어 놓고 S3 와 같은 클라우드 저장소를 활용해 CDN 을 통해 전송하면 좋다.

### 서비스

**위치 서비스**

- 데이터의 일관성 보다 가용성이 더 중요함, CAP 정리에 따르면 일관성, 가용성, 분할 내성을 모두 만족시킬 방법은 없으므로 가용성과 분할 내성을 만족하는데 집중한다.
    
    [https://www.ibm.com/kr-ko/topics/cap-theorem](https://www.ibm.com/kr-ko/topics/cap-theorem)
    
- 높은 가용성을 보장하면서 막대한 규모의 연산을 감당하려면 카산드라를 추천한다.
    - 데이터 베이스 키로 user_id, timestamp 를 조합하고 그 값으로 위도와 경도 쌍을 저장한다.
    - 특정 사용자의 최근 위치를 읽기 위해 user_id 를 파티션 키, 시간 순 정렬을 위해 timestamp 는 클러스터링 키로 활용한다.
    
    | key(user_id) | timestamp | lat | long | user_mode | navigation_mode |
    | --- | --- | --- | --- | --- | --- |
    | 51 | 1320530000 | 21.9 | 83.3 | active | driving |

**위치 데이터 이용 방법**

- 데이터를 활용하면 실시간 교통 현황이나, 개설 도로 혹은 폐쇠된 도로를 감지할 수 있으므로 카프카와 같은 메시지 큐로 로깅한다.
- 개별 서비스는 각각의 데이터를 활용하여 서비스의 품질을 높인다.
    
    ![여러서비스제공.drawio.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%258B%25E1%2585%25A7%25E1%2584%2585%25E1%2585%25A5%25E1%2584%2589%25E1%2585%25A5%25E1%2584%2587%25E1%2585%25B5%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258C%25E1%2585%25A6%25E1%2584%2580%25E1%2585%25A9%25E1%2586%25BC.drawio.png" | relative_url }})
    

### 지도 표시

**지도 타일 사전 계산**

구글맵과 같이 21단계로 지도를 확대할 수 있도록 설정한다. 확대 수준의 경우 1단계 올릴 때마다 이전 수준 대비 타일 수는 4배씩 늘어난다.

**최적화: 벡터 사용**

WebGL 을 사용하는 경우 이미지 대신 벡터 타일을 사용할 수 있다. 그 장점은 대역폭 절약을 위한 월등한 압축률과 매끄러운 지도 확대 경험이다.

### 경로 안내 서비스

![경로안내서비스.drawio.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%2580%25E1%2585%25A7%25E1%2586%25BC%25E1%2584%2585%25E1%2585%25A9%25E1%2584%258B%25E1%2585%25A1%25E1%2586%25AB%25E1%2584%2582%25E1%2585%25A2%25E1%2584%2589%25E1%2585%25A5%25E1%2584%2587%25E1%2585%25B5%25E1%2584%2589%25E1%2585%25B3.drawio.png" | relative_url }})

**지오코딩 서비스**

출발지와 목적지 주소를 위도-경도 쌍으로 변환한 뒤 다른 서비스 호출에 이용한다.

**경로 계획 서비스**

현재 교통 상황과 도로 상태에 입각해 이동 시간 측면에서 최적화 된 경로를 제안한다.

**최단 경로 서비스**

출발지 목적지에 따라 도로 구조에만 의존하여 교통이나 도로 상황을 고려하지 않은 k개의 최단 경로를 반환한다. 도로망 그래프가 거의 정적이므로 캐시를 사용하면 좋다.

**예상 도착 시간 서비스**

최단 경로 목록을 가지고 현재 교통 상황을 반영하여 예상 도착 시간의 추정치를 구한다. 실시간 교통 상황 뿐 아니라 앞으로의 교통상황도 예측해야 한다.

**순위 결정 서비스**

ETA 예상치를 가지고 사용자가 정의한 필터링 조건을 적용해 소요 시간 순으로 정렬하여 k 개를 반환한다.

**중요 정보 갱신 서비스**

카프카 위치 데이터 스트림을 구독하는 서비스들로 비동기적으로 데이터를 업데이트 한다. 

- 실시간 교통 정보 업데이트
- 개설, 폐쇄 도로 경로 안내 타일 업데이트

**적응형 ETA 와 경로 변경**

경로 안내를 받고 있는 모든 사용자를 추적하여 교통 상황이 달라질 때 ETA 를 변경해야 하지만 이번 설계에서 제외한다.

**전송 프로토콜**

서버에서 클라이언트에게 경로의 상황 변경에 대한 안내가 필요하므로 안정적인 방법이 필요하다.

후보: 모바일 푸시 알림, 롱 폴링, 웹소켓, SSE(서버 전송 이벤트)

- 모바일 푸시 알림의 경우 메시지 크기가 제한(최대 4096b)적이거 웹 지원이 안되므로 제외
- 서버의 부담이 덜한 롱폴링 보다 덜한 웹소켓은 괜찮은 방법이다.
- 실시간 양방향 통신을 위한 요구사항이 있을 수 있으므로 SSE 보다 웹소켓을 사용한다.

## 4단계: 마무리

![최종설계안.drawio.png]({{ "/assets/img/study/books/system-design-interview-vol2/chapter03/%25E1%2584%258E%25E1%2585%25AC%25E1%2584%258C%25E1%2585%25A9%25E1%2586%25BC%25E1%2584%2589%25E1%2585%25A5%25E1%2586%25AF%25E1%2584%2580%25E1%2585%25A8%25E1%2584%258B%25E1%2585%25A1%25E1%2586%25AB.drawio.png" | relative_url }})

시스템을 확장해본다면 실시간 교통 상황을 고려 하여 안내해주는 경유지 설정 기능을 제공해보자.